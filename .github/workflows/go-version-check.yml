# Check for new Go versions and create issues/PRs when updates are available
name: Go Version Check

on:
  schedule:
    # Run every Monday at 10:00 JST (01:00 UTC)
    - cron: "0 1 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-go-version:
    name: Check Go Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get current Go version from go.mod
        id: current
        run: |
          # Get full version from go.mod (e.g., 1.25.3 or 1.25)
          CURRENT_VERSION=$(grep -E "^go [0-9]+\.[0-9]+" go.mod | awk '{print $2}')
          # Extract major.minor for comparison (e.g., 1.25 from 1.25.3)
          CURRENT_MINOR=$(echo $CURRENT_VERSION | cut -d. -f1,2)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "minor=$CURRENT_MINOR" >> $GITHUB_OUTPUT
          echo "Current Go version: $CURRENT_VERSION (minor: $CURRENT_MINOR)"

      - name: Get latest stable Go version
        id: latest
        run: |
          # Fetch latest stable Go version from official API
          LATEST_VERSION=$(curl -s https://go.dev/dl/?mode=json | jq -r '.[0].version' | sed 's/go//')
          # Extract major.minor (e.g., 1.25 from 1.25.5)
          LATEST_MINOR=$(echo $LATEST_VERSION | cut -d. -f1,2)
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "minor=$LATEST_MINOR" >> $GITHUB_OUTPUT
          echo "Latest Go version: $LATEST_VERSION (minor: $LATEST_MINOR)"

      - name: Compare versions
        id: compare
        run: |
          CURRENT_MINOR="${{ steps.current.outputs.minor }}"
          LATEST_MINOR="${{ steps.latest.outputs.minor }}"
          LATEST_FULL="${{ steps.latest.outputs.version }}"
          
          # Compare major.minor versions numerically
          CURRENT_MAJOR=$(echo $CURRENT_MINOR | cut -d. -f1)
          CURRENT_MIN=$(echo $CURRENT_MINOR | cut -d. -f2)
          LATEST_MAJOR=$(echo $LATEST_MINOR | cut -d. -f1)
          LATEST_MIN=$(echo $LATEST_MINOR | cut -d. -f2)
          
          # Check if latest is actually newer (not just different)
          if [ "$LATEST_MAJOR" -gt "$CURRENT_MAJOR" ] || \
             ([ "$LATEST_MAJOR" -eq "$CURRENT_MAJOR" ] && [ "$LATEST_MIN" -gt "$CURRENT_MIN" ]); then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT_MINOR -> $LATEST_MINOR (full: $LATEST_FULL)"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Go version is up to date ($CURRENT_MINOR >= $LATEST_MINOR)"
          fi

      - name: Create update branch and PR
        if: steps.compare.outputs.update_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_MINOR="${{ steps.current.outputs.minor }}"
          LATEST_MINOR="${{ steps.latest.outputs.minor }}"
          LATEST_FULL="${{ steps.latest.outputs.version }}"
          BRANCH_NAME="deps/go-$LATEST_MINOR"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, skipping..."
            exit 0
          fi
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          # Update go.mod to new minor version (release.yml reads from go.mod automatically)
          sed -i "s/^go $CURRENT_MINOR.*/go $LATEST_MINOR/" go.mod
          
          # Run go mod tidy to update go.sum
          go mod tidy || true
          
          # Commit changes
          git add go.mod go.sum
          git commit -m "deps(go): update Go version from $CURRENT_MINOR to $LATEST_MINOR"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Ensure labels exist (create if not)
          gh label create "dependencies" --description "Dependency updates" --color "0366d6" 2>/dev/null || true
          gh label create "go" --description "Go related changes" --color "00ADD8" 2>/dev/null || true
          
          # Create PR
          gh pr create \
            --title "deps(go): update Go version from $CURRENT_MINOR to $LATEST_MINOR" \
            --body "## Go Version Update

          This PR updates the Go version from \`$CURRENT_MINOR\` to \`$LATEST_MINOR\` (latest patch: \`$LATEST_FULL\`).

          ### Changes
          - Updated \`go.mod\` to use Go $LATEST_MINOR
          - \`release.yml\` will automatically use this version via \`go-version-file: 'go.mod'\`

          ### Release Notes
          See the [Go $LATEST_MINOR release notes](https://go.dev/doc/go$LATEST_MINOR) for details.

          ---
          *This PR was automatically created by the Go Version Check workflow.*" \
            --label "dependencies" \
            --label "go"
