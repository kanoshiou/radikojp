# Check for new Go versions and create issues/PRs when updates are available
name: Go Version Check

on:
  schedule:
    # Run every Monday at 10:00 JST (01:00 UTC)
    - cron: "0 1 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-go-version:
    name: Check Go Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get current Go version from go.mod
        id: current
        run: |
          CURRENT_VERSION=$(grep -E "^go [0-9]+\.[0-9]+" go.mod | awk '{print $2}')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Go version: $CURRENT_VERSION"

      - name: Get latest stable Go version
        id: latest
        run: |
          # Fetch latest stable Go version from official API
          LATEST_VERSION=$(curl -s https://go.dev/dl/?mode=json | jq -r '.[0].version' | sed 's/go//')
          # Extract major.minor (e.g., 1.22 from 1.22.1)
          LATEST_MINOR=$(echo $LATEST_VERSION | cut -d. -f1,2)
          echo "version=$LATEST_MINOR" >> $GITHUB_OUTPUT
          echo "full_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Go version: $LATEST_VERSION (minor: $LATEST_MINOR)"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Go version is up to date"
          fi

      - name: Create update branch and PR
        if: steps.compare.outputs.update_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          FULL_LATEST="${{ steps.latest.outputs.full_version }}"
          BRANCH_NAME="deps/go-$LATEST"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, skipping..."
            exit 0
          fi
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          # Update go.mod
          sed -i "s/^go $CURRENT/go $LATEST/" go.mod
          
          # Update release.yml if it specifies Go version
          if grep -q "go-version:" .github/workflows/release.yml; then
            sed -i "s/go-version: '$CURRENT'/go-version: '$LATEST'/" .github/workflows/release.yml
            sed -i "s/go-version: \"$CURRENT\"/go-version: \"$LATEST\"/" .github/workflows/release.yml
          fi
          
          # Commit changes
          git add go.mod .github/workflows/release.yml
          git commit -m "deps(go): update Go version from $CURRENT to $LATEST"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "deps(go): update Go version from $CURRENT to $LATEST" \
            --body "## Go Version Update

          This PR updates the Go version from \`$CURRENT\` to \`$LATEST\` (latest: \`$FULL_LATEST\`).

          ### Changes
          - Updated \`go.mod\` to use Go $LATEST
          - Updated \`.github/workflows/release.yml\` to build with Go $LATEST

          ### Release Notes
          See the [Go $FULL_LATEST release notes](https://go.dev/doc/go$LATEST) for details.

          ---
          *This PR was automatically created by the Go Version Check workflow.*" \
            --label "dependencies" \
            --label "go"
