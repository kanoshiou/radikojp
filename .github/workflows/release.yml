name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build
    strategy:
      matrix:
        include:
          - os: windows-latest
            goos: windows
            goarch: amd64
            output: radiko-windows-amd64.exe
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            output: radiko-linux-amd64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            output: radiko-macos-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            output: radiko-macos-arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: go build -ldflags="-s -w" -o ${{ matrix.output }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Move artifacts to root
        run: |
          find artifacts -type f -exec mv {} . \;

      - name: Create checksums
        run: |
          sha256sum radiko-* > checksums.txt

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            radiko-windows-amd64.exe
            radiko-linux-amd64
            radiko-macos-amd64
            radiko-macos-arm64
            checksums.txt
          body: |
            ## Radiko TUI ${{ steps.get_version.outputs.VERSION }}
            
            A Terminal User Interface (TUI) for streaming Radiko Japanese internet radio.
            
            ### âœ¨ Features
            
            - ğŸµ Stream live Radiko radio stations
            - ğŸ—¾ Support for all 47 Japanese prefectures
            - ğŸ–¥ï¸ Interactive terminal UI (TUI)
            - ğŸ”Š Volume control with mute & precise adjustment
            - ğŸ”„ Auto-reconnect on stream failure
            - ğŸ’¾ Remembers last station, region, and settings
            
            ### ğŸ“¦ Downloads
            
            Choose the version for your system:
            
            - **Windows (x64)**: `radiko-windows-amd64.exe`
            - **Linux (x64)**: `radiko-linux-amd64`
            - **macOS (Intel)**: `radiko-macos-amd64`
            - **macOS (Apple Silicon)**: `radiko-macos-arm64`
            
            ### âš ï¸ Requirements
            
            **ffmpeg is required** for audio decoding:
            
            - Windows: `choco install ffmpeg` or `winget install ffmpeg`
            - Linux: `sudo apt install ffmpeg`
            - macOS: `brew install ffmpeg`
            
            ### ğŸ® Controls
            
            | Key | Action |
            |-----|--------|
            | â†‘/â†“ or k/j | Navigate stations |
            | â†/â†’ or h/l | Switch regions |
            | Enter/Space | Play station |
            | +/- | Volume up/down |
            | 0-9 | Set volume level (0=0%, 5=50%, 9=90%) |
            | m | Toggle mute |
            | r | Reconnect stream |
            | Esc | Exit |
            
            ### ğŸ’¾ Configuration
            
            Settings are saved automatically:
            - **Windows**: `%APPDATA%\radiko-tui\config.json`
            - **macOS**: `~/Library/Application Support/radiko-tui/config.json`
            - **Linux**: `~/.config/radiko-tui/config.json`
            
            ### âœ… Checksums
            
            Verify file integrity after download by referring to `checksums.txt`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
